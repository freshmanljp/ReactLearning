<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>redux简易原理</title>
</head>
<body>
  <div>
    <button onclick="store.dispatch({type:'sub', num: 2})">-</button>
    <span id="counter">0</span>
    <button onclick="store.dispatch({type:'add', num: 3})">+</button>
  </div>
  <script>
    const counter = document.querySelector('#counter')
    const countState = {
      count: 0
    }
    // *******************最简易的方式实现状态管理*****************************
    // 管理state数据的方法原型，没有把数据和方法管理放到一起
    // const changeState = (action, state) => {
    //   switch(action.type) {
    //     case 'add':
    //       state.count += action.num
    //       break
    //     case 'sub':
    //       state.count -= action.num
    //       break
    //     default:
    //       break
    //   }
    // }
    // // action触发dispatch来管理state数据方法原型
    // const dispatch = (action) => {
    //   changeState(action, countState)
    //   renderCounter(countState)
    // }
    // // state数据改变时渲染原型
    // const renderCounter = (state) => {
    //   counter.innerHTML = state.count
    // }
    // renderCounter(countState)
    // **********************************************************
    // 改进的简易redux实现方式
    // 数据和方法放到一起管理的方式，数据在store内部，方法也在store内部执行，渲染函数也在内部进行管理
    // 自定义的初始化state结构和管理state的函数，用action标记
    const changeState = (state, action) => {
      // 初始化state的值
      if (!state) {
        return countState
      }
      switch(action.type) {
        case 'add':
          return {
            // 复制一遍state，修改要修改的值
            ...state,
            count:  state.count += action.num
          }
        case 'sub':
          return {
              ...state,
              count:  state.count -= action.num
          }
        default:
          return state
      }
    }
    // 创建状态管理store的方法
    const creatStore = (changeState) => {
      let state = null
      // 每次dispatch后要自动执行的函数
      let listeners = []
      // 获取state的方法 
      const getState = () => {
        return state
      }
      // action通过dispatch管理状态的方法
      const dispatch = (action) => {
        state = changeState(state, action)
        // 自动执行函数列表内的函数都执行一遍
        listeners.forEach(listener => {
          listener()
        })
      }
      // 添加要自动执行的函数
      const subcribe = (listener) => {
        listeners.push(listener)
      }
      // 初始化一次state
      dispatch()
      // 返回store状态管理要用到的方法
      return {
        getState,
        dispatch,
        subcribe
      }
    }
    // 创建状态管理store
    const store = creatStore(changeState)
    // 数据渲染函数定义
    const renderCounter = () => {
      counter.innerHTML = store.getState().count
    }
    store.subcribe(renderCounter)
  </script>
</body>
</html>